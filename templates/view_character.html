<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Character</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <style>
        /* Custom CSS */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #FFD700;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
            --sidebar-width: 250px;
            --sidebar-bg: #343a40;
        }

        /* Add dynamic health bar styles */
        .health-bar {
            height: 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .vp-bar {
            background-color: #28a745;  /* Solid green for VP */
        }

        .wp-bar {
            background-color: #dc3545;  /* Solid red for WP */
        }

        body {
            font-family: 'Cinzel', serif;
            background-color: #f9f9f9;
            color: #111;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
            overflow-y: auto;
            color: white;
        }

        .sidebar.collapsed {
            transform: translateX(calc(-1 * var(--sidebar-width)));
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            border-radius: 0;
            padding: 10px 15px;
            margin: 2px 0;
            transition: all 0.3s;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: var(--secondary-color);
            color: white;
            border-left: 4px solid var(--accent-color);
        }

        .sidebar .nav-link i {
            margin-right: 8px;
        }

        /* Main Content Styles */
        .main-content {
            position: relative;
            margin-left: var(--sidebar-width);
            padding: 20px;
            min-height: 100vh;
            width: calc(100% - var(--sidebar-width));
            transition: margin-left 0.3s ease-in-out, width 0.3s ease-in-out;
            background-color: #f9f9f9;
        }

        .main-content.expanded {
            margin-left: 0;
            width: 100%;
        }

        /* Card Styles */
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            padding: 12px 15px;
        }

        /* Special inspired state */
        .inspired {
            background-color: var(--accent-color);
            color: black;
        }

        .inspired .card-header {
            background-color: darkorange;
        }

        /* Stat box styling */
        .stat-box {
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            height: 100%;
        }

        .stat-inner-box {
            background-color: rgba(240, 240, 240, 0.6);
            border-radius: 6px;
            padding: 8px;
            margin-top: 5px;
        }

        .modifier {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 3px 0;
        }

        .value {
            font-size: 1rem;
        }

        .label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        /* Button styling */
        .btn-character {
            background-color: var(--primary-color);
            color: white;
            font-size: 0.85rem;
            border: none;
            margin: 2px;
        }

        .btn-character:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        /* Currency styling */
        .coin {
            padding: 4px 6px;
            border-radius: 3px;
            min-width: 60px;
            text-align: center;
            color: black;
            font-weight: bold;
            display: inline-block;
            margin: 3px;
        }

        .gold { background-color: #D4AF37; }
        .silver { background-color: #C0C0C0; }
        .copper { background-color: #B87333; }

        /* Table styling */
        .table-character {
            font-size: 0.9rem;
        }

        .table-character th {
            background-color: var(--primary-color);
            color: white;
        }

        /* Section styling */
        .section {
            padding-top: 60px;
            margin-top: -50px;
        }

        /* Mobile adjustments */
        @media (max-width: 767.98px) {
            .sidebar {
                transform: translateX(calc(-1 * var(--sidebar-width)));
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding-top: 60px;
            }

            .mobile-menu {
                display: block !important;
            }

            /* General mobile adjustments */
            body {
                font-size: 14px;
            }

            .main-content {
                padding: 10px;
            }

            /* More compact cards on mobile */
            .card {
                margin-bottom: 10px;
                border-radius: 8px;
            }

            .card-body {
                padding: 10px;
            }

            .card-header {
                padding: 8px 10px;
                font-size: 1rem;
            }

            /* Compact stat boxes */
            .stat-box {
                padding: 8px;
                margin-bottom: 8px;
            }

            .stat-inner-box {
                padding: 5px;
                margin-top: 3px;
            }

            /* Adjust text sizes for mobile */
            .modifier {
                font-size: 1rem;
                margin: 2px 0;
            }

            .value {
                font-size: 0.9rem;
            }

            .label {
                font-size: 0.9rem;
                margin-bottom: 3px;
            }

            /* More compact buttons */
            .btn-character {
                padding: 4px 8px;
                font-size: 0.8rem;
            }

            /* Optimize tables for mobile */
            .table-character {
                font-size: 0.8rem;
            }

            .table-character td, 
            .table-character th {
                padding: 4px 8px;
            }

            /* Adjust spacing for sections */
            .section {
                padding-top: 40px;
                margin-top: -30px;
            }

            /* Make sidebar more compact */
            .sidebar {
                min-height: auto;
                height: auto;
                position: relative;
            }

            .sidebar .nav-link {
                padding: 8px 12px;
                margin: 1px 0;
                font-size: 0.9rem;
            }

            /* Optimize currency display */
            .coin {
                padding: 2px 4px;
                min-width: 50px;
                font-size: 0.8rem;
                margin: 2px;
            }

            /* Make forms more compact */
            .form-control, .form-select {
                padding: 4px 8px;
                font-size: 0.9rem;
                height: auto;
            }

            /* Optimize button groups */
            .btn-group {
                gap: 2px;
            }

            .btn-group .btn {
                padding: 4px 8px;
            }

            /* Make character avatar smaller */
            .character-avatar {
                width: 60px;
                height: 60px;
                font-size: 1.8rem;
                margin-bottom: 10px;
            }

            /* Optimize grid spacing */
            .row {
                margin-left: -5px;
                margin-right: -5px;
            }

            .col, [class*="col-"] {
                padding-left: 5px;
                padding-right: 5px;
            }

            /* Hide hover effects on mobile */
            .card:hover {
                transform: none;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
        }

        /* Modal styling */
        .modal-character .modal-header {
            background-color: var(--primary-color);
            color: white;
        }

        /* Special elements */
        .character-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--light-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px auto;
            font-size: 2.5rem;
            color: var(--primary-color);
            border: 3px solid var(--primary-color);
        }
    </style>
    <script>
        // Store scroll position before form submission
        document.addEventListener('DOMContentLoaded', function() {
            // Restore scroll position if available
            let scrollPos = sessionStorage.getItem('scrollPos');
            if (scrollPos) {
                // Use instant scroll behavior to prevent animation
                window.scrollTo({
                    top: parseInt(scrollPos),
                    behavior: 'instant'  // This makes it instant instead of smooth scrolling
                });
                sessionStorage.removeItem('scrollPos');
            }

            // Add scroll position to all forms before submission
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function() {
                    sessionStorage.setItem('scrollPos', window.scrollY);
                });
            });
        });
    </script>
</head>
<body data-active-vp="{{ character.active_vitality_points }}" data-max-vp="{{ character.max_vitality_points }}" class="{% if character.is_inspired %} inspired {% endif %}">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="text-center p-3 border-bottom">
            <div class="character-avatar">
                <i class="fas fa-user-shield"></i>
            </div>
            <h4 class="mb-0">{{ character.name }}</h4>
            <p>Level {{ character.level }} {{ character.race }}</p>
        </div>

        <nav class="nav flex-column mt-2">
            <a class="nav-link" href="#overview"><i class="fas fa-home"></i> Overview</a>
            <a class="nav-link" href="#attributes"><i class="fas fa-fist-raised"></i> Attributes</a>
            <a class="nav-link" href="#abilities"><i class="fas fa-bolt"></i> Abilities</a>
            <a class="nav-link" href="#Traits_and_Proficiencies"><i class="fas fa-scroll"></i> Traits & Proficiencies</a>
            <a class="nav-link" href="#Manual_Debuffs"><i class="fas fa-skull"></i> Apply Buffs or Debuffs</a>
            <a class="nav-link" href="#inventory"><i class="fas fa-suitcase"></i> Inventory</a>
            <a class="nav-link" href="#on_the_ground"><i class="fas fa-box"></i> On The Ground</a>
            <a class="nav-link" href="#stored_at_home"><i class="fas fa-warehouse"></i> Stored At Home</a>
            <a class="nav-link" href="#" onclick="toggleView(); return false;">
                <i class="fas {% if view_mode == 'mobile' %}fa-desktop{% else %}fa-mobile-alt{% endif %}"></i>
                {% if view_mode == 'mobile' %}Desktop View{% else %}Mobile View{% endif %}
            </a>
            <a class="nav-link" href="{{ url_for('index') }}"><i class="fas fa-home"></i>Home</a>
        </nav>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Mobile Toggle Button -->
        <div class="d-md-none mobile-menu fixed-top bg-dark py-2 px-3 d-flex justify-content-between align-items-center shadow-sm">
            <button class="btn btn-outline-light" type="button" id="sidebarToggleButton">
                <i class="fas fa-bars"></i>
            </button>
            <h5 class="mb-0 text-light">{{ character.name }}</h5>
        </div>

        <!-- Desktop Toggle Button -->
        <div class="d-none d-md-block position-fixed" style="left: 10px; top: 10px; z-index: 1001;">
            <button class="btn btn-sm btn-dark" id="desktopSidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <div class="d-md-none" style="height: 56px;"></div>
        
        <!-- Content Sections -->
        <div class="container-fluid px-0">
            <!-- Overview Section -->
            <section id="overview" class="section">
                <div class="card {% if character.is_inspired %} inspired {% endif %}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Overview</h5>
                        <div class="d-flex">
                           <!-- Short Rest Button -->
<button id="shortRestButton" type="button" class="btn btn-sm btn-light me-2" onclick="handleShortRest()">
    <i class="fas fa-bed"></i> Short Rest
</button>
                            <form action="{{ url_for('long_rest', name=character.name) }}" method="post">
                                <button type="submit" class="btn btn-sm btn-light me-2">
                                    <i class="fas fa-moon"></i> Long Rest
                                </button>
                            </form>
                            <button type="button" class="btn btn-sm btn-light me-2" onclick="openLevelUpModal()">
                                <i class="fas fa-level-up-alt"></i> Level Up
                            </button>
                            <form action="{{ url_for('is_inspired', name=character.name) }}" method="post">
                                <button type="submit" class="btn btn-sm btn-light">
                                    <i class="fas fa-star"></i>
                                    {% if character.is_inspired %}
                                    Use Inspiration
                                    {% else %}
                                    Inspiration
                                    {% endif %}
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Basic Info & Movement, Health Status, and Currency Row -->
                        <div class="row">
                            <!-- Basic Info & Movement -->
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h6 class="mb-0">Basic Info & Movement</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="stat-inner-box mb-2">
                                            <p><strong>Height/Weight:</strong> {{ character.height }} ft / {{ character.weight }} lb</p>
                                        <p><strong>Passive Perception:</strong> {{ character.passive_perception }}</p>
                                    </div>
                                    <div class="stat-inner-box">
                                        <p><strong>Speed:</strong> {{ character.active_movement_speed }}</p>
                                        <p><strong>AC:</strong> {{ character.total_ac }}</p>
                                        {% set encumbrance_levels = {
                                        0: "Unencumbered",
                                        1: "Lightly Encumbered",
                                        2: "Moderately Encumbered",
                                        3: "Heavily Encumbered",
                                        4: "Extremely Encumbered",
                                        5: "Can't move"
                                        } %}
                                            <p><strong>Encumbrance:</strong> {{ encumbrance_levels.get(character.encumbrance, "Unknown") }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Health Status -->
                            <div class="col-md-5">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h6 class="mb-0">Health Status</h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- VP Section -->
                                        <div class="mb-3">
                                                <p class="mb-1">Vitality Points</p>
                                            <p class="modifier">{{ character.active_vitality_points }} / {{ character.max_vitality_points }}</p>
                                        <div class="progress mb-2" style="height: 8px;">
                                            <div class="progress-bar health-bar vp-bar" role="progressbar"
                                                 style="width: {% if character.max_vitality_points > 0 %}{{ (character.active_vitality_points / character.max_vitality_points) * 100 }}{% else %}0{% endif %}%"
                                                         aria-valuenow="{{ character.active_vitality_points }}"
                                                         aria-valuemin="0"
                                                         aria-valuemax="{{ character.max_vitality_points }}">
                                                    </div>
                                                </div>
                                            <form action="{{ url_for('update_character', name=character.name) }}" method="post" class="mb-2">
                                                <div class="btn-group btn-group-sm w-100">
                                                    <button type="submit" name="decrease_vitality" class="btn btn-character">
                                                        <i class="fas fa-minus"></i> VP
                                                    </button>
                                                    <button type="submit" name="increase_vitality" class="btn btn-character"
                                                            {% if character.active_vitality_points == character.max_vitality_points %}disabled{% endif %}>
                                                        <i class="fas fa-plus"></i> VP
                                                    </button>
                                                    <button type="submit" name="heal_vitality" class="btn btn-success"
                                                            {% if character.active_vitality_points == character.max_vitality_points %}disabled{% endif %}>
                                                        <i class="fas fa-heart"></i> Full
                                                    </button>
                                            </div>
                                            </form>
                                        </div>

                                        <!-- WP Section -->
                                        <div>
                                                <p class="mb-1">Wound Points</p>
                                            <p class="modifier">{{ character.active_wound_points }} / {{ character.max_wound_points }}</p>
                                            <div class="progress mb-2" style="height: 8px;">
                                                <div class="progress-bar health-bar wp-bar" role="progressbar"
                                                     style="width: {% if character.max_wound_points > 0 %}{{ (character.active_wound_points / character.max_wound_points) * 100 }}{% else %}0{% endif %}%"
                                                         aria-valuenow="{{ character.active_wound_points }}"
                                                         aria-valuemin="0"
                                                         aria-valuemax="{{ character.max_wound_points }}">
                                                    </div>
                                                </div>
                                            <form action="{{ url_for('update_character', name=character.name) }}" method="post">
                                                <div class="btn-group btn-group-sm w-100">
                                                <button type="submit" name="decrease_wound" class="btn btn-character">
                                                    <i class="fas fa-minus"></i> WP
                                                </button>
                                                <button type="submit" name="increase_wound" class="btn btn-character"
                                                            {% if character.active_wound_points == character.max_wound_points %}disabled{% endif %}>
                                                    <i class="fas fa-plus"></i> WP
                                                </button>
                                                    <button type="submit" name="heal_wound" class="btn btn-success"
                                                            {% if character.active_wound_points == character.max_wound_points %}disabled{% endif %}>
                                                        <i class="fas fa-heart"></i> Full
                                                    </button>
                                                </div>
                                            </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                            <!-- Currency -->
                            <div class="col-md-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h6 class="mb-0">Currency</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex flex-column align-items-center mb-2">
                                            <span class="coin gold mb-1">Gold: {{ character.gold }}</span>
                                            <span class="coin silver mb-1">Silver: {{ character.silver }}</span>
                                            <span class="coin copper mb-1">Copper: {{ character.copper }}</span>
                                                </div>
                                        <form action="{{ url_for('update_purse', name=character.name) }}" method="post">
                                            <div class="input-group input-group-sm mb-2">
                                                <input type="number" id="amount" name="amount" class="form-control" placeholder="Amount" required min="0">
                                                        <select id="currency" name="currency" class="form-select">
                                                            <option value="gold">Gold</option>
                                                            <option value="silver">Silver</option>
                                                            <option value="copper">Copper</option>
                                                        </select>
                                            </div>
                                            <div class="btn-group btn-group-sm w-100">
                                                <input type="hidden" id="operation" name="operation" value="add">
                                                <button type="submit" class="btn btn-success" onclick="document.getElementById('operation').value='add'">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                                <button type="submit" class="btn btn-danger" onclick="document.getElementById('operation').value='subtract'">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                    </div>
                                                </form>
                                        {% if purse_error %}
                                        <div class="alert alert-danger mt-2 mb-0 py-1 small text-center">
                                            <i class="fas fa-exclamation-circle"></i> {{ purse_error }}
                                            </div>
                                        {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Combat Equipment Row -->
                    <div class="row mt-3">
                        <div class="col-12">
                <div class="card">
                    <div class="card-header">
                                <h6 class="mb-0">Combat Equipment</h6>
                            </div>
                                    <div class="card-body p-2">
                                        <div class="row">
                                            <!-- Weapon Card -->
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                                                        <div>
                                                            <h6 class="mb-0">{{ character.weapon.name if character.weapon.name else 'Unarmed' }}</h6>
                                                            <div class="d-flex gap-3 mt-1">
                                                                <small>To Hit: <span class="text-white">{{ character.weapon_hit_chances|int if character.weapon_hit_chances|int < 0 else '+' + character.weapon_hit_chances|string }}</span></small>
                                                                <small>Damage Mod: <span class="text-white">{{ character.weapon_total_damage_modifier|int if character.weapon_total_damage_modifier|int < 0 else '+' + character.weapon_total_damage_modifier|string }}</span></small>
                                                            </div>
                                                        </div>
                                                        <button type="button" class="btn btn-character" data-bs-toggle="collapse" data-bs-target="#weaponDetails">
                                                            <i class="fas fa-chevron-down"></i>
                                                        </button>
                                                    </div>
                                                    <div class="collapse" id="weaponDetails">
                            <div class="card-body">
                                                        <div class="stat-inner-box mb-3">
                                                            <form action="/character/{{ character.name }}/equip_weapon" method="POST">
                                                                <label for="weapon">Select Weapon:</label>
                                                                <select id="weapon" name="selected_weapon"
                                                                        class="form-select form-select-sm" onchange="submitFormWithScroll(this.form)">
                                                                    <option value="Unarmed" {% if not character.weapon.name %}selected{% endif %}>
                                                                        Unarmed
                                                                    </option>
                                                                    {% for item in weapon_items %}
                                                                    <option value="{{ item['item_name'] }}" {% if item['item_name'] == character.weapon.name %}selected{% endif %}>
                                                                        {{ item['item_name'] }}
                                                                    </option>
                                                                    {% endfor %}
                                                                </select>
                                                            </form>
                                        </div>

                                                        <div class="stat-inner-box mb-3">
                                                            <form action="/character/{{ character.name }}/apply_weapon_proficiency" method="POST">
                                                                <label for="weapon_proficiency">Select Proficiency:</label>
                                                                <select id="weapon_proficiency" name="selected_weapon_proficiency"
                                                                        class="form-select form-select-sm" onchange="submitFormWithScroll(this.form)">
                                                                    <option value="NO_SELECTION" {% if not character.weapon.weapon_proficiency %}selected{% endif %}>
                                                                        None Applies
                                                                    </option>
                                                                    {% for skill_name in character.skills.keys() %}
                                                                    <option value="{{ skill_name }}" {% if skill_name == character.weapon.weapon_proficiency %}selected{% endif %}>
                                                                        {{ skill_name }}
                                                                    </option>
                                                                    {% endfor %}
                                                                </select>
                                                            </form>
                                    </div>

                                                        <div class="row mb-2">
                                                            <div class="col-md-6">
                                                                <div class="stat-inner-box">
                                                                    <p class="mb-1">Weapon Damage Dice</p>
                                                                    <p class="modifier">{{ character.weapon.damage_dice }}</p>
                                        </div>
                                                            </div>
                                                            <div class="col-md-6">
                                        <div class="stat-inner-box">
                                                                    <p class="mb-1">Weapon Modifier</p>
                                                                    <p class="modifier">{{ character.weapon.weapon_modifiers|int if character.weapon.weapon_modifiers|int < 0 else '+' + character.weapon.weapon_modifiers|string }}</p>
                                        </div>
                                    </div>
                                </div>

                                        <div class="stat-inner-box">
                                                            <p class="mb-1">Stat Modifier</p>
                                                            <p class="modifier">{{ character.weapon.weapon_stat_modifier }}</p>
                                    </div>

                                                        <div class="stat-inner-box">
                                                            <p class="mb-1">Weapon Conditions</p>
                                                            <p class="modifier">{{ character.weapon.weapon_conditions }}</p>
                                    </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                                        <!-- Armor Card -->
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="mb-0">{{ character.armor.name if character.armor.name else 'No Armor' }}</h6>
                                                        <div class="d-flex gap-3 mt-1">
                                                            <small>AC: <span class="text-white">{{ character.total_ac }}</span></small>
                                                            {% if character.shield_equipped %}
                                                            <small><i class="fas fa-shield-alt text-white"></i></small>
                                                            {% endif %}
                                                            {% if character.temp_armor_modifier != 0 %}
                                                            <small>Temp: <span class="text-white">{{ character.temp_armor_modifier|int if character.temp_armor_modifier|int < 0 else '+' + character.temp_armor_modifier|string }}</span></small>
                                                            {% endif %}
                                </div>
                            </div>
                                                    <button type="button" class="btn btn-character" data-bs-toggle="collapse" data-bs-target="#armorDetails">
                                                        <i class="fas fa-chevron-down"></i>
                                                    </button>
                                </div>
                                                <div class="collapse" id="armorDetails">
                                                    <div class="card-body">
                                                        <div class="stat-inner-box mb-3">
                                                            <form action="/character/{{ character.name }}/equip_armor" method="POST">
                                                                <label for="armor">Select Armor:</label>
                                                                <select id="armor" name="selected_armor" class="form-select form-select-sm" onchange="submitFormWithScroll(this.form)">
                                                                    <option value="No Armor" {% if not character.armor.name %}selected{% endif %}>No Armor</option>
                                                                    {% for item in armor_items %}
                                                                    <option value="{{ item['item_name'] }}" {% if item['item_name'] == character.armor.name %}selected{% endif %}>
                                                                        {{ item['item_name'] }}
                                                                    </option>
                                                                    {% endfor %}
                                                                </select>
                                                            </form>
                                                        </div>

                                                        <div class="stat-inner-box mb-3">
                                                            <form action="/character/{{ character.name }}/toggle_shield" method="POST">
                                                                <div class="form-check">
                                                                    <input type="checkbox" id="shield_equipped" name="shield_equipped" class="form-check-input" 
                                                                        {% if character.shield_equipped %}checked{% endif %} 
                                                                        onchange="submitFormWithScroll(this.form)">
                                                                    <label for="shield_equipped" class="form-check-label">Shield Equipped</label>
                                                                </div>
                                                            </form>
                                                        </div>

                                <div class="stat-inner-box">
                                                            <form action="/character/{{ character.name }}/update_temporary_armor_modifier" method="POST">
                                                                <label for="temporary_armor_modifier">Temporary Armor Effect:</label>
                                                                <div class="input-group input-group-sm">
                                                                    <input type="number" id="temporary_armor_modifier" name="temporary_armor_modifier"
                                                                        value="{{ character.temp_armor_modifier }}" step="1" class="form-control"
                                                                        onchange="submitFormWithScroll(this.form)">
                                </div>
                                                            </form>
                                    </div>
                                </div>
                            </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Row for Fatigue Stats -->
                        <div class="row mt-3">
                            <!-- Fatigue Stats Column -->
                            <div class="col-md-12">
                                <div class="row g-2">
                                    <!-- Injury Fatigue -->
                                    <div class="col-md-4">
                                        <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Injury Fatigue</h6>
                                    </div>
                                            <div class="card-body py-2">
                                                <div class="stat-inner-box mb-0">
                                                    <p class="modifier mb-0">{{ character.injury_fatigue }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                                    <!-- Exhaustion -->
                                    <div class="col-md-4">
                                        <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Exhaustion</h6>
                                    </div>
                                            <div class="card-body py-2">
                                                <div class="stat-inner-box mb-0">
                                                    <p class="modifier mb-0">{{ character.exhaustion }}</p>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-2">
                                            <form action="{{ url_for('update_character', name=character.name) }}"
                                                          method="post" class="d-flex">
                                                <button type="submit" name="increase_exhaustion"
                                                        class="btn btn-character">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                                <button type="submit" name="decrease_exhaustion"
                                                        class="btn btn-character">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <button type="submit" name="heal_exhaustion" class="btn btn-character">
                                                    <i class="fas fa-sync"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>

                                    <!-- Manual Injury Fatigue -->
                                    <div class="col-md-4">
                                        <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Manual Injury Fatigue</h6>
                                    </div>
                                            <div class="card-body py-2">
                                                <div class="stat-inner-box mb-0">
                                                    <p class="modifier mb-0">{{ character.extra_injury_fatigue }}</p>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-2">
                                            <form action="{{ url_for('update_character', name=character.name) }}"
                                                          method="post" class="d-flex">
                                                <button type="submit" name="increase_extra_injury_fatigue"
                                                        class="btn btn-character">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                                <button type="submit" name="decrease_extra_injury_fatigue"
                                                        class="btn btn-character">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <button type="submit" name="heal_extra_injury_fatigue"
                                                        class="btn btn-character">
                                                    <i class="fas fa-sync"></i>
                                                </button>
                                            </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Attributes Section -->
            <section id="attributes" class="section">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Attributes</h5>
                    </div>
                    <div class="card-body">
                        <!-- First Row: Strength, Dexterity, Constitution -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <div class="stat-box">
                                    <h6 class="mb-1">Strength</h6>
                                    <div class="stat-inner-box py-1">
                                        <p class="modifier mb-0">{{ character.ST_modifier }}</p>
                                    </div>
                                    <p class="value mb-0">{{ character.active_ST }}</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-box">
                                    <h6 class="mb-1">Dexterity</h6>
                                    <div class="stat-inner-box py-1">
                                        <p class="modifier mb-0">{{ character.DX_modifier }}</p>
                                    </div>
                                    <p class="value mb-0">{{ character.active_DX }}</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-box">
                                    <h6 class="mb-1">Constitution</h6>
                                    <div class="stat-inner-box py-1">
                                        <p class="modifier mb-0">{{ character.CN_modifier }}</p>
                                    </div>
                                    <p class="value mb-0">{{ character.active_CN }}</p>
                                </div>
                            </div>
                        </div>
                        <!-- Second Row: Intelligence, Willpower, Charisma -->
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="stat-box">
                                    <h6 class="mb-1">Intelligence</h6>
                                    <div class="stat-inner-box py-1">
                                        <p class="modifier mb-0">{{ character.IN_modifier }}</p>
                                    </div>
                                    <p class="value mb-0">{{ character.active_IN }}</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-box">
                                    <h6 class="mb-1">Willpower</h6>
                                    <div class="stat-inner-box py-1">
                                        <p class="modifier mb-0">{{ character.WP_modifier }}</p>
                                    </div>
                                    <p class="value mb-0">{{ character.active_WP }}</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-box">
                                    <h6 class="mb-1">Charisma</h6>
                                    <div class="stat-inner-box py-1">
                                        <p class="modifier mb-0">{{ character.CH_modifier }}</p>
                                    </div>
                                    <p class="value mb-0">{{ character.active_CH }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Abilities, Traits & Proficiencies Section -->
            <section id="abilities" class="section">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Character Features</h5>
                    </div>
                    <div class="card-body">
                        <!-- First Row: Abilities, Traits, and Proficiencies -->
                        <div class="row">
                            <!-- Active Abilities Column -->
                            <div class="col-md-4">
                                <h5 class="mb-3">Active Abilities</h5>
                                {% for ability in character.active_abilities|sort(attribute='name') %}
                                <div class="card mb-2">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">{{ ability.name }}</h6>
                                        <div class="btn-group btn-group-sm">
                                            <form action="{{ url_for('use_ability', name=character.name, ability_id=ability.id) }}" method="post" class="d-inline">
                                                <button type="submit" class="btn btn-character" {% if ability.uses_left == 0 %} disabled {% endif %}>
                                                    Use ({{ ability.uses_left }}/{{ ability.uses_per_long_rest }})
                                                </button>
                                            </form>
                                            <form action="{{ url_for('decrease_dc', name=character.name, ability_id=ability.id) }}" method="post" class="d-inline">
                                                <button type="submit" class="btn btn-character">
                                                    <i class="fas fa-arrow-down"></i> DC
                                                </button>
                                            </form>
                                            <form action="{{ url_for('increase_dc', name=character.name, ability_id=ability.id) }}" method="post" class="d-inline">
                                                <button type="submit" class="btn btn-character">
                                                    <i class="fas fa-arrow-up"></i> DC
                                                </button>
                                            </form>
                                            <button type="button" class="btn btn-character" data-bs-toggle="collapse" data-bs-target="#ability{{ ability.id }}">
                                                <i class="fas fa-chevron-down"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="collapse" id="ability{{ ability.id }}">
                                        <div class="card-body">
                                            <p><strong>Description:</strong> {{ ability.description }}</p>
                                            <p><strong>DC:</strong> {{ ability.dc }}</p>
                                            <div class="d-flex justify-content-end">
                                                <form action="{{ url_for('remove_active_ability', name=character.name, ability_id=ability.id) }}" method="post">
                                                <button type="submit" class="btn btn-danger btn-sm">
                                                        <i class="fas fa-trash"></i> Remove
                                                </button>
                                            </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                                <button id="toggleFormButton" class="btn btn-character mt-2">
                                    <i class="fas fa-plus"></i> Add Active Ability
                                </button>

                                <div id="addAbilityForm" class="card mt-3" style="display: none;">
                                    <div class="card-header">
                                        <h6 class="mb-0">Add Active Ability</h6>
                                    </div>
                                    <div class="card-body">
                                        <form action="{{ url_for('add_active_ability', name=character.name) }}" method="post">
                                            <div class="mb-2">
                                                <label for="ability_name" class="form-label">Ability Name:</label>
                                                <input type="text" id="ability_name" name="ability_name" class="form-control form-control-sm" required>
                                            </div>
                                            <div class="mb-2">
                                                <label for="ability_description" class="form-label">Description:</label>
                                                <textarea id="ability_description" name="ability_description" class="form-control form-control-sm" required></textarea>
                                            </div>
                                            <div class="mb-2">
                                                <label for="ability_dc" class="form-label">DC:</label>
                                                <input type="number" id="ability_dc" name="ability_dc" class="form-control form-control-sm" required>
                                            </div>
                                            <div class="mb-2">
                                                <label for="rest_type" class="form-label">Recharges on:</label>
                                                <select id="rest_type" name="rest_type" class="form-select form-select-sm" required>
                                                    <option value="short_rest">Short Rest</option>
                                                    <option value="long_rest">Long Rest</option>
                                                </select>
                                            </div>
                                            <div class="mb-2">
                                                <label for="ability_uses" class="form-label">Uses per Rest:</label>
                                                <input type="number" id="ability_uses" name="ability_uses" class="form-control form-control-sm" required>
                                            </div>
                                            <button type="submit" class="btn btn-character">Add Ability</button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Traits Column -->
                            <div class="col-md-4">
                                <h5 class="mb-3">Traits</h5>
                                {% for trait in character.traits|sort(attribute='name') %}
                                <div class="card mb-2">
                                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                                        <h6 class="mb-0">{{ trait.name }}</h6>
                                        <button type="button" class="btn btn-character" data-bs-toggle="collapse" data-bs-target="#trait{{ trait.id }}">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    <div class="collapse" id="trait{{ trait.id }}">
                                        <div class="card-body py-2">
                                            <p class="mb-2">{{ trait.description }}</p>
                                            <div class="d-flex justify-content-end">
                                                <form action="{{ url_for('remove_trait', name=character.name, trait_id=trait.id) }}" method="post">
                                                    <button type="submit" class="btn btn-danger btn-sm">
                                                        <i class="fas fa-trash"></i> Remove
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                                <button type="button" class="btn btn-character mt-2" data-bs-toggle="collapse" data-bs-target="#addTraitForm">
                                    <i class="fas fa-plus"></i> Add Trait
                                </button>

                                <div class="collapse mt-3" id="addTraitForm">
                                    <div class="card">
                                    <div class="card-body">
                                            <form method="post" action="{{ url_for('add_trait', name=character.name) }}">
                                                <div class="mb-2">
                                                    <label for="trait_name" class="form-label">Trait Name:</label>
                                                    <input type="text" id="trait_name" name="trait_name" class="form-control form-control-sm" required>
                                                </div>
                                                <div class="mb-2">
                                                    <label for="trait_description" class="form-label">Description:</label>
                                                    <textarea id="trait_description" name="trait_description" class="form-control form-control-sm" required></textarea>
                                                </div>
                                                <button type="submit" class="btn btn-character">Add Trait</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Proficiencies Column -->
                            <div class="col-md-4">
                                <h5 class="mb-3">Proficiencies</h5>
                                <div class="table-responsive">
                                    <table class="table table-sm table-character">
                                        <tbody>
                                            {% for skill, data in character.skills.items()|sort %}
                                            <tr class="align-middle">
                                                <td>{{ skill }}</td>
                                                <td class="text-end"><strong>{{ data.get("total_value", 0) }}</strong></td>
                                                <td class="text-end" style="width: 80px;">
                                                    <div class="btn-group btn-group-sm">
                                                        <form action="{{ url_for('decrease_proficiency', name=character.name, proficiency_id=skill )}}" method="post" class="d-inline">
                                                            <button type="submit" class="btn btn-character btn-sm px-1">
                                                                <i class="fas fa-minus"></i>
                                                            </button>
                                                        </form>
                                                        <form action="{{ url_for('increase_proficiency', name=character.name, proficiency_id=skill )}}" method="post" class="d-inline">
                                                            <button type="submit" class="btn btn-character btn-sm px-1">
                                                                <i class="fas fa-plus"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <button type="button" class="btn btn-character mt-2" data-bs-toggle="collapse" data-bs-target="#addProficiencyForm">
                                    <i class="fas fa-plus"></i> Add Proficiency
                                </button>

                                <div class="collapse mt-3" id="addProficiencyForm">
                                    <div class="card">
                                        <div class="card-body">
                                            <form method="post" action="{{ url_for('add_custom_skill', name=character.name) }}">
                                                <div class="mb-2">
                                                    <label for="custom_skill_name" class="form-label">Proficiency Name:</label>
                                                    <input type="text" id="custom_skill_name" name="custom_skill_name" class="form-control form-control-sm" required>
                                                </div>
                                                <button type="submit" class="btn btn-character">Add Proficiency</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Second Row: Buffs and Debuffs -->
                        <div class="row mt-4">
                            <!-- Active Buffs and Debuffs Column -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Active Buffs and Debuffs</h5>
                                    </div>
                                    <div class="card-body">
                                        {% if character.injury_fatigue_debuffs %}
                                            <p>{{ character.injury_fatigue_debuffs | safe }}</p>
                                        {% endif %}
                                        {% set debuff_labels = {
                                        "debuff_st": "Strength",
                                        "debuff_dx": "Dexterity",
                                        "debuff_in": "Intelligence",
                                        "debuff_ch": "Charisma",
                                        "debuff_cn": "Constitution",
                                        "debuff_wp": "Wisdom",
                                        "debuff_movement": "Movement Speed",
                                        "debuff_carry_capacity":"Carry Capacity By Size",
                                        "debuff_height": "Height",
                                        "debuff_max_vp": "Max Vitality Points",
                                        "debuff_max_wp": "Max Wound Points"
                                        } %}
                                        {% set has_active_debuffs = false %}
                                        {% for debuff in character.debuffs %}
                                            {% if debuff.value != 0 %}
                                                {% if not has_active_debuffs %}
                                                    {% set has_active_debuffs = true %}
                                                {% endif %}
                                                <div class="stat-inner-box mb-2">
                                            {% if debuff.name in debuff_labels %}
                                            <span>{{ debuff.value }} {{ debuff_labels[debuff.name] }} by {{ debuff.reason }}</span>
                                            {% else %}
                                            {% set name_parts = debuff.name.split('_') %}
                                            {% if name_parts|length > 1 %}
                                            <span>{{ debuff.value }} {{ name_parts[1] | replace('_', ' ') }} by {{ debuff.reason }}</span>
                                            {% else %}
                                            <span>{{ debuff.value }} {{ debuff.name }} by {{ debuff.reason }}</span>
                                            {% endif %}
                                            {% endif %}

                                                {% if debuff.removable %}
                                                        <form action="{{ url_for('remove_debuff', name=character.name, debuff_id=debuff.id) }}" method="post" style="display: inline;">
                                                            <button type="submit" class="btn btn-danger btn-sm" style="display: inline-block;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                        </div>
                                            {% endif %}
                                        {% endfor %}
                                        {% if not has_active_debuffs and not character.injury_fatigue_debuffs and not character.extra_injury_fatigue %}
                                            <p class="text-muted text-center mb-0">No active buffs or debuffs</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Apply New Buff/Debuff Column -->
                            <div class="col-md-6">
        <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Apply New Buff/Debuff</h5>
                                        <button type="button" class="btn btn-character" data-bs-toggle="collapse" data-bs-target="#newDebuffForm">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
            </div>
                                    <div class="collapse" id="newDebuffForm">
            <div class="card-body">
                    <form action="{{ url_for('add_debuff', name=character.name) }}" method="post">
                                                <div class="mb-3">
                                                    <label for="debuff" class="form-label">Choose Stat/Skill:</label>
                                    <select id="debuff" name="debuff_name" class="form-select form-select-sm">
                                        <option value="debuff_st">Strength</option>
                                        <option value="debuff_dx">Dexterity</option>
                                        <option value="debuff_in">Intelligence</option>
                                        <option value="debuff_ch">Charisma</option>
                                        <option value="debuff_cn">Constitution</option>
                                        <option value="debuff_wp">Wisdom</option>
                                        <option value="debuff_movement">Movement Speed</option>
                                        <option value="debuff_AC">Armor Class</option>
                                        <option value="debuff_carry_capacity">Carry Capacity By Size</option>
                                        <option value="debuff_height">Height</option>
                                        <option value="debuff_max_vp">Max Vitality Points</option>
                                        <option value="debuff_max_wp">Max Wound Points</option>
                                        {% for skill_name in character.skills.keys() %}
                                        <option value="debuff_{{ skill_name|replace(' ', '_') }}">{{ skill_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                                <div class="mb-3">
                                                    <label for="debuff_value" class="form-label">Value (positive number):</label>
                                                    <input type="number" id="debuff_value" name="debuff_value" class="form-control form-control-sm" min="0" step="any" required>
                            </div>
                                                <div class="mb-3">
                                    <label for="debuff_reason" class="form-label">Reason:</label>
                                    <input type="text" id="debuff_reason" name="debuff_reason" class="form-control form-control-sm">
                                </div>
                                                <div class="btn-group">
                                                    <button type="submit" name="operation" value="buff" class="btn btn-success">
                                                        <i class="fas fa-plus"></i> Apply as Buff
                                                    </button>
                                                    <button type="submit" name="operation" value="debuff" class="btn btn-danger">
                                                        <i class="fas fa-minus"></i> Apply as Debuff
                                                    </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
                    </div>
                </div>
            </section>

            <!-- Inventory Section -->
            <section id="inventory" class="section">
        <div class="card">
            <div class="card-header">
                Inventory
                        <a href="{{ url_for('add_item', name=character.name) }}" class="btn btn-danger btn-sm" style="float: right;">Add Item</a>
            </div>
            <div class="card-body">
                <table class="table table-character">
                    <tr>
                        <th>Units</th>
                        <th>Item Name</th>
                        <th>Weight</th>
                        <th>Total Weight</th>
                        <th>Actions</th>
                    </tr>
                    {% for item in character.inventory %}
                    <tr>
                        <td>{{ item.units }}</td>
                        <td>{{ item.item_name }}</td>
                        <td>{{ item.weight_per_unit }}</td>
                        <td>{{ item.total_weight }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                        <form action="{{ url_for('store_item', name=character.name) }}" method="POST" class="d-inline">
                                    <input type="hidden" name="item_name" value="{{ item.item_name }}">
                                            <button type="submit" class="btn btn-danger btn-sm">Store</button>
                                </form>
                                        <form action="{{ url_for('drop_item', name=character.name) }}" method="POST" class="d-inline">
                                    <input type="hidden" name="item_name" value="{{ item.item_name }}">
                                    <button type="submit" class="btn btn-danger btn-sm">Drop</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    <tr class="inventory-total">
                        <td colspan="3" style="text-align: right;"><strong>TOTAL Inventory Weight:</strong></td>
                        <td><strong>{{ character.inventory|sum(attribute='total_weight') }}</strong></td>
                        <td></td>
                    </tr>
                </table>
            </div>
        </div>
    </section>

            <!-- On The Ground Section -->
            <section id="on_the_ground" class="section">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Items on the Ground</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-character">
                            <tr>
                                <th>Units</th>
                                <th>Item Name</th>
                                <th>Weight</th>
                                <th>Total Weight</th>
                                <th>Actions</th>
                            </tr>
                            {% for item in character.on_the_ground %}
                            <tr>
                                <td>{{ item.units }}</td>
                                <td>{{ item.item_name }}</td>
                                <td>{{ item.weight_per_unit }}</td>
                                <td>{{ item.total_weight }}</td>
                                <td>
                                    <form action="{{ url_for('pickup_item', name=character.name) }}" method="POST" class="d-inline">
                                        <input type="hidden" name="item_name" value="{{ item.item_name }}">
                                        <button type="submit" class="btn btn-danger btn-sm">Pick Up</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </table>
                        <div class="mt-3">
                            <form action="{{ url_for('reset_on_the_ground', name=character.name) }}" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-danger btn-sm">Clear Ground Items</button>
                        </form>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Storage Section -->
            <section id="stored_at_home" class="section">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Storage</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-character">
                            <tr>
                                <th>Units</th>
                                <th>Item Name</th>
                                <th>Weight</th>
                                <th>Total Weight</th>
                                <th>Actions</th>
                            </tr>
                            {% for item in character.house_inventory %}
                            <tr>
                                <td>{{ item.units }}</td>
                                <td>{{ item.item_name }}</td>
                                <td>{{ item.weight_per_unit }}</td>
                                <td>{{ item.total_weight }}</td>
                                <td>
                                    <form action="{{ url_for('pickup_item', name=character.name) }}" method="POST" class="d-inline">
                                        <input type="hidden" name="item_name" value="{{ item.item_name }}">
                                        <button type="submit" class="btn btn-danger btn-sm">Pick Up</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
            </section>

            <!-- Character Notes Section -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                                <i class="fas fa-sticky-note"></i> Notes
                </h5>
            </div>
            <div class="card-body">
                            <!-- Notes Table -->
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if character.notes %}
                                {% for note_id, note in character.notes.items() %}
                                <tr>
                                    <td width="15%">{{ note.date }}</td>
                                    <td>{{ note.content }}</td>
                                    <td width="15%">
                                                    <div class="btn-group btn-group-sm">
                                                        <button onclick="editNote('{{ note_id }}', '{{ note.content|replace("'", "\\'") }}')" class="btn btn-primary">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <form action="{{ url_for('delete_note', name=character.name, note_id=note_id) }}" method="post" class="d-inline">
                                                            <button type="submit" class="btn btn-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                                    </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <div class="mt-3">
                    <form id="noteForm" action="{{ url_for('add_note', name=character.name) }}" method="post">
                        <input type="hidden" id="note_id" name="note_id" value="">
                        <div class="input-group">
                            <input type="text" id="note_content" name="note_content" class="form-control" placeholder="Enter a new note..." required>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus"></i> Add Note
                            </button>
                            <button type="button" id="cancelEditBtn" class="btn btn-secondary" style="display: none;" onclick="cancelEdit()">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
        </main>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
<script> document.getElementById("toggleFormButton").addEventListener("click", function() {
        var formDiv = document.getElementById("addAbilityForm");
        formDiv.style.display = formDiv.style.display === "none" ? "block" : "none";
    });
</script>
<script>
    function editNote(noteId, content) {
        document.getElementById('note_id').value = noteId;
        document.getElementById('note_content').value = content;
        document.getElementById('noteForm').action = "{{ url_for('edit_note', name=character.name) }}";
        document.querySelector('#noteForm button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Update Note';
        document.getElementById('cancelEditBtn').style.display = 'block';
    }

    function cancelEdit() {
        document.getElementById('note_id').value = '';
        document.getElementById('note_content').value = '';
        document.getElementById('noteForm').action = "{{ url_for('add_note', name=character.name) }}";
        document.querySelector('#noteForm button[type="submit"]').innerHTML = '<i class="fas fa-plus"></i> Add Note';
        document.getElementById('cancelEditBtn').style.display = 'none';
    }

    function toggleNoteVisibility(type) {
        const privateNotes = document.querySelectorAll('.private-note');
        const publicNotes = document.querySelectorAll('.public-note');
        
        if (type === 'private') {
            privateNotes.forEach(note => note.style.display = '');
            publicNotes.forEach(note => note.style.display = 'none');
        } else {
            privateNotes.forEach(note => note.style.display = 'none');
            publicNotes.forEach(note => note.style.display = '');
        }
    }

    function toggleGroundItems(type) {
        const localItems = document.querySelectorAll('.local-item');
        const globalItems = document.querySelectorAll('.global-item');
        
        if (type === 'local') {
            localItems.forEach(item => item.style.display = '');
            globalItems.forEach(item => item.style.display = 'none');
        } else {
            localItems.forEach(item => item.style.display = 'none');
            globalItems.forEach(item => item.style.display = '');
        }
    }

    function toggleStorageItems(type) {
        const personalItems = document.querySelectorAll('.personal-storage');
        const sharedItems = document.querySelectorAll('.shared-storage');
        
        if (type === 'personal') {
            personalItems.forEach(item => item.style.display = '');
            sharedItems.forEach(item => item.style.display = 'none');
        } else {
            personalItems.forEach(item => item.style.display = 'none');
            sharedItems.forEach(item => item.style.display = '');
        }
    }
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');
        const mobileToggle = document.getElementById('sidebarToggleButton');
        const desktopToggle = document.getElementById('desktopSidebarToggle');

        function toggleSidebar() {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }

        if (mobileToggle) {
            mobileToggle.addEventListener('click', function() {
                sidebar.classList.toggle('show');
            });
        }

        if (desktopToggle) {
            desktopToggle.addEventListener('click', toggleSidebar);
        }

        // Close sidebar when clicking links on mobile
        const sidebarLinks = document.querySelectorAll('.sidebar a');
        sidebarLinks.forEach(function(link) {
            link.addEventListener('click', function() {
                if (window.innerWidth < 768) {
                    sidebar.classList.remove('show');
                }
            });
        });
    });
</script>
<script>
    function handleShortRest() {
        const activeVP = {{ character.active_vitality_points }};
        const maxVP = {{ character.max_vitality_points }};
        
        if (activeVP < maxVP) {
            const modal = new bootstrap.Modal(document.getElementById('shortRestModal'));
            modal.show();
        } else {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('short_rest', name=character.name) }}";
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>

<!-- Popup Modal for Level Up -->
<div id="levelUpModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 300px; border-radius: 5px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);">
        <span class="close" onclick="closeLevelUpModal()" style="color: #000; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h5 style="color: #000;">Level Up<br>Roll for new Vitality Points and add Wound Points</h5>

        <form id="levelUpForm" action="{{ url_for('level_up', name=character.name) }}" method="POST">
            <div class="mb-3">
                <label for="hit_dice_roll" class="form-label" style="color: #000;">Enter your VP roll ({{ character.hit_dice }}):</label>
                <input type="number" id="hit_dice_roll" name="hit_dice_roll" class="form-control form-control-sm"
                       placeholder="Enter VP roll" min="1" required style="color: #000; background-color: #fff;">
            </div>
            <div class="mb-3">
                <label for="increase_wound_points" class="form-label" style="color: #000;">Increase Wound Points by:</label>
                <input type="number" id="increase_wound_points" name="increase_wound_points" class="form-control form-control-sm"
                       placeholder="Enter WP increase" min="0" value="0" required style="color: #000; background-color: #fff;">
            </div>
            <button type="submit" class="btn btn-sm btn-success" style="color: #fff;">
                <i class="fas fa-check"></i> Confirm Level Up
            </button>
        </form>
    </div>
</div>

<script>
function openLevelUpModal() {
    document.getElementById("levelUpModal").style.display = "block";
}

function closeLevelUpModal() {
    document.getElementById("levelUpModal").style.display = "none";
}

// Close the modal if user clicks outside of it
window.onclick = function(event) {
    var shortRestModal = document.getElementById("shortRestModal");
    var levelUpModal = document.getElementById("levelUpModal");
    
    if (event.target == shortRestModal) {
        shortRestModal.style.display = "none";
    }
    if (event.target == levelUpModal) {
        levelUpModal.style.display = "none";
    }
}
</script>
<script>
    function submitFormWithScroll(form) {
        sessionStorage.setItem('scrollPos', window.scrollY);
        form.submit();
    }
</script>
<script>
    function toggleView() {
        const currentUrl = new URL(window.location.href);
        const currentView = currentUrl.searchParams.get('view') || 'desktop';
        const newView = currentView === 'desktop' ? 'mobile' : 'desktop';
        currentUrl.searchParams.set('view', newView);
        window.location.href = currentUrl.toString();
    }
</script>

<!-- Short Rest Modal -->
<div class="modal fade" id="shortRestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Short Rest</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="shortRestForm" action="{{ url_for('short_rest', name=character.name) }}" method="post">
                    <div class="mb-3">
                        <label class="form-label">Roll your hit dice ({{ character.hit_dice }}) and enter the value:</label>
                        <input type="number" name="hit_dice_roll" class="form-control" required min="1">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Take Short Rest</button>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
</html>

